---
title: "Park Flies Microbiome Analysis"
output: learnr::tutorial
runtime: shiny_prerendered
description: "Comparative Analysis of the Microbiome of PD flies and Control flies"
---

```{r setup, include=FALSE}

library(lme4)
library(multcomp)
library(dunn.test)
library(rcompanion)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(reshape)
library(ade4)
library(grid)
library(gtable)
library(PMCMR)
library(multcompView)
library(splitstackshape)
library(readxl)
library(reshape2)
library(survival)
library(maps)
library(dplyr)
library(vegan)
library(cowplot)
library(stringr)
library(exactRankTests)
library(readr)


library(devtools)
library(usethis)
library(roxygen2)
library(learnr)


source(url("https://raw.githubusercontent.com/emarsh25/parkFliesMicrobiome/master/Files/16sscripts/make_taxon_plots_condense_2var_0.0.2.R"))
source(url("https://raw.githubusercontent.com/emarsh25/parkFliesMicrobiome/master/Files/16sscripts/g_legend.R"))
source(url("https://raw.githubusercontent.com/emarsh25/parkFliesMicrobiome/master/Files/16sscripts/pcoa_2var_0.0.2.R"))
source(url("https://raw.githubusercontent.com/emarsh25/parkFliesMicrobiome/master/Files/16sscripts/make_ancom_plots_0.0.2.R"))
source(url("https://raw.githubusercontent.com/emarsh25/parkFliesMicrobiome/master/Files/16sscripts/ancom_tests.R"))
source(url("https://raw.githubusercontent.com/emarsh25/parkFliesMicrobiome/master/Files/16sscripts/ancom_v2.0.R"))


knitr::opts_chunk$set(echo = FALSE)
```

## Introduction

### Welcome to the Parkinson Flies Microbiome Analysis Figures

In this tutorial you will see how all figures were created for the Parkinson Flies Microbiome Paper. Feel free to experiment with the tutorial by changing the taxon levels or other similar changes.

## Bash Work

### Using QIIME2


source activate qiime2-2019.7

cd ~/Park-Proj/Evan_stuff/parkFlies/Files/CURA_project

name=call19
mapper=call_mapper.tsv
seqsdir=reads/


*filter out wolbachia reads*
qiime taxa filter-table \
  --i-table table-$name"".qza \
  --i-taxonomy taxonomy-$name"".qza \
  --p-exclude Wolbachia \
  --o-filtered-table table-$name""_noW.qza
  
*filter out individual OTUs*
qiime feature-table filter-features\
  --i-table table-$name""_noW.qza \
  --m-metadata-file OTUs.tsv \
  --p-exclude-ids \
  --o-filtered-table table-$name""_feature.qza
  
*filter other unwanted contents*
qiime taxa filter-table \
  --i-table table-$name"".qza \
  --i-taxonomy taxonomy-$name"".qza \
  --p-exclude Mitochondira,Chloroplast,Archaea,Wolbachia \
  --o-filtered-table table-$name""_noOther.qza



bash ../16sscripts/standard_qiime3.sh $name""_noW $name UCLA_controls 164 $mapper "lab = 'UCLA' AND genotype_class = 'control'"

bash ../16sscripts/standard_qiime3.sh $name""_noW $name UCLA_mutants 164 $mapper "lab = 'UCLA' AND genotype_class = 'mutant'"

bash ../16sscripts/standard_qiime3.sh $name""_noW $name UCLA 164 $mapper "lab = 'UCLA'"



bash ../16sscripts/standard_qiime3.sh $name""_noW $name Stanford_controls 2974 $mapper "lab = 'Stanford' AND genotype_class = 'control'"

bash ../16sscripts/standard_qiime3.sh $name""_noW $name Stanford_mutants 2974 $mapper "lab = 'Stanford' AND genotype_class = 'mutant'"

bash ../16sscripts/standard_qiime3.sh $name""_noW $name Stanford 2974 $mapper "lab = 'Stanford'"



bash ../16sscripts/standard_qiime3.sh $name""_noW $name Pallanck_controls 7188 $mapper "lab = 'Pallanck'AND genotype_class = 'control'"

bash ../16sscripts/standard_qiime3.sh $name""_noW $name Pallanck_mutants 7188 $mapper "lab = 'Pallanck'AND genotype_class = 'mutant'"

bash ../16sscripts/standard_qiime3.sh $name""_noW $name Pallanck 7188 $mapper "lab = 'Pallanck'"



bash ../16sscripts/standard_qiime3.sh $name""_noW $name Bellen_controls 1565 $mapper "lab = 'Bellen' AND genotype_class = 'control'"

bash ../16sscripts/standard_qiime3.sh $name""_noW $name Bellen_mutants_174 1565 $mapper "lab = 'Bellen' AND genotype = 'iPLA2-VIA[Delta174]'"

bash ../16sscripts/standard_qiime3.sh $name""_noW $name Bellen_mutants_192 1565 $mapper "lab = 'Bellen' AND genotype = 'iPLA2-VIA[Delta192]'"

bash ../16sscripts/standard_qiime3.sh $name""_noW $name Bellen 1565 $mapper "lab = 'Bellen'"



bash ../16sscripts/standard_qiime3.sh $name""_feature $name All 200 $mapper "lab IN ('UCLA','Stanford','Bellen','Pallanck')"




bash ../16sscripts/standard_qiime3.sh $name""_noW $name iPLA174_noControl 1565 $mapper "genotype IN ('iPLA2-VIA[Delta174]')"

bash ../16sscripts/standard_qiime3.sh $name""_noW $name iPLA174 1565 $mapper "genotype IN ('iPLA2-VIA Control','iPLA2-VIA[Delta174]')"

bash ../16sscripts/standard_qiime3.sh $name""_noW $name Bloom_174 1565 $mapper "lab = 'Bloomington' AND genotype = 'iPLA2-VIA[Delta174]'"



bash ../16sscripts/standard_qiime3.sh $name""_noW $name iPLA192_noControl 1565 $mapper "genotype IN ('iPLA2-VIA[Delta192]')"

bash ../16sscripts/standard_qiime3.sh $name""_noW $name iPLA192 1565 $mapper "genotype IN ('iPLA2-VIA Control','iPLA2-VIA[Delta192]')"

bash ../16sscripts/standard_qiime3.sh $name""_noW $name Bloom_192 1565 $mapper "lab = 'Bloomington' AND genotype = 'iPLA2-VIA[Delta192]'"





















## Figure 1

*All sections of this figure were created seperately and then brought together with grid arrange*

### UCLA Control Taxon Chart

```{r ucla_control, exercise=TRUE}

file_path <- "UCLA_controls"
urlpath <- "https://raw.githubusercontent.com/emarsh25/parkFliesMicrobiome/master/Files/Analyses/UCLA_controls/"
mapper_file <- url("https://raw.githubusercontent.com/emarsh25/parkFliesMicrobiome/master/Files/Analyses/UCLA_controls/call_mapper.tsv")

var1 = "genotype"
taxonomic_level = "genus"
rpa_in_chart = 0.04 ### relative percent abundance in chart -> taxa that are at least this abundant overall will show up
the_two_var = "onevar" ## ignore
the_id = "X.SampleID" ## ignore
plot_color = c("black","brown","blue","red")
plot_order = c("Lactobacillaceae", "Lactobacillus","Acetobacter")
x_val = "genotype"
read_depth = 164
map_path = "-call19" ## name of the taxonomy file; write instructions on how to create a taxonomy file - taxonomy_forR.csv
legend_position = "none"

ucla_control_taxon <- make_taxon_plots_1var(urlpath = urlpath, file_path = file_path,	map_path = map_path, mapper_file = mapper_file, var1 = var1, taxonomic_level = taxonomic_level,	rpa_in_chart = rpa_in_chart,	the_two_var = "onevar",	the_id = "X.SampleID",	plot_color = plot_color,	plot_order = plot_order,	x_val = x_val,read_depth = read_depth, legend_position = legend_position)

flies.labs <- c("PG (Control)", "pink15")
names(flies.labs) <- c("PG (Control)", "pink15")
ucla_control_taxon <- ucla_control_taxon + facet_grid(.~get(var1), drop = TRUE, space = "free", scales = "free", labeller = labeller(.cols = flies.labs)) +
  theme(
      strip.text.x = element_text(
        size = 30, color = "black", face = "bold"
        )
      )+ 
  xlab("Fly Samples") + 
  ylab("Fractional Abundance") +
  labs(fill = "Order Level Taxon")

plot(ucla_control_taxon)

```


### UCLA Mutant Taxon Chart

```{r ucla_mutant, exercise=TRUE}

file_path <- "UCLA_mutants"
urlpath <- "https://raw.githubusercontent.com/emarsh25/parkFliesMicrobiome/master/Files/Analyses/UCLA_mutants/"
mapper_file <- url("https://raw.githubusercontent.com/emarsh25/parkFliesMicrobiome/master/Files/Analyses/UCLA_mutants/call_mapper.tsv")

var1 = "genotype"
taxonomic_level = "genus"
rpa_in_chart = 0.05 ### relative percent abundance in chart -> taxa that are at least this abundant overall will show up
the_two_var = "onevar" ## ignore
the_id = "X.SampleID" ## ignore
plot_color = c("black","green","brown")
plot_order = c("Enterococcus", "Lactobacillaceae")
x_val = "genotype"
read_depth = 164
map_path = "-call19" ## name of the taxonomy file; write instructions on how to create a taxonomy file - taxonomy_forR.csv
legend_position = "none"

ucla_mutant_taxon <- make_taxon_plots_1var(urlpath = urlpath, file_path = file_path,	map_path = map_path, mapper_file = mapper_file, var1 = var1, taxonomic_level = taxonomic_level,	rpa_in_chart = rpa_in_chart,	the_two_var = "onevar",	the_id = "X.SampleID",	plot_color = plot_color,	plot_order = plot_order,	x_val = x_val,read_depth = read_depth, legend_position = legend_position)

flies.labs <- c("PG", "pink15 (UCLA)")
names(flies.labs) <- c("PG (Control)", "pink15")
ucla_mutant_taxon <- ucla_mutant_taxon + facet_grid(.~get(var1), drop = TRUE, space = "free", scales = "free", labeller = labeller(.cols = flies.labs)) +
  theme(
      strip.text.x = element_text(
        size = 30, color = "black", face = "bold"
        )
      )+ 
  xlab("Fly Samples") + 
  ylab("Fractional Abundance") +
  labs(fill = "Order Level Taxon")

plot(ucla_mutant_taxon)

```
